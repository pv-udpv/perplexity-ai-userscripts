# Copilot Instructions for perplexity-ai-userscripts

## Project Overview
This repository contains userscripts for Perplexity AI enhancement, built with **ViteMonkey** (TypeScript/modern JS) and **Tampermonkey** compatibility.

## Tech Stack
- **Build Tool**: ViteMonkey (Vite + userscript adapter)
- **Language**: TypeScript 5.0+
- **Runtime**: Browser userscript environment (Tampermonkey, Violentmonkey)
- **Package Manager**: `uv pip` (Python-based, can also use `npm` for Node deps)
- **Testing**: Vitest + DOM testing
- **Linting**: ESLint + Prettier (strict mode)

## Code Style & Rules
1. **TypeScript First**: Strict mode, no `any`, explicit types
2. **Async/Await**: Use async patterns, avoid callback hell
3. **DOM Selectors**: Use `document.querySelector` or `element.addEventListener` for clean event binding
4. **Storage**: Prefer `GM_setValue`/`GM_getValue` for persistence (Tampermonkey API)
5. **Logging**: Use namespaced console: `console.log('[perplexity-userscript]', ...)`
6. **Error Handling**: Try-catch for async ops, graceful degradation
7. **Performance**: Debounce rapid events, avoid memory leaks with cleanup
8. **Compatibility**: Target modern browsers (Chrome 90+, Firefox 88+)

## Development Workflow
1. Create new script in `/scripts/<script-name>/` directory
2. Structure: `index.ts` (main entry), `manifest.json` (userscript metadata), `utils.ts` (helpers)
3. Build with `npm run build` or `vite build`
4. Test locally with Tampermonkey in browser dev mode
5. Open PR with test results and demo GIF if applicable

## PR Requirements
- [ ] TypeScript compiles without errors (`tsc --noEmit`)
- [ ] Passes linting (`npm run lint`)
- [ ] Unit tests added for new logic (`npm run test`)
- [ ] No Perplexity API hardcoding; use config/env variables
- [ ] Userscript header properly formatted (auto-generated by ViteMonkey)
- [ ] Works on latest Perplexity AI (test before submitting)

## When Working With Copilot
- **Generate**: Start with feature requests like "Add keyboard shortcut for clearing chat history"
- **Iterate**: Test locally first, then ask for refinements
- **Review**: Check generated code for XSS vulnerabilities, especially DOM manipulation
- **Delegate**: Use "Create a PR" or "Open an issue" for complex features
- **Sync**: Keep Copilot context updated with latest userscript behavior/feedback

## Key Constraints
- No jQuery (modern DOM API only)
- No external CDN dependencies (bundle everything or use import maps)
- Respect Perplexity TOS (don't automate paid features without consent)
- Handle rate limiting gracefully
- Userscript must load within 2s, main logic must be non-blocking

## File Structure
```
scripts/
├── script-name-1/
│   ├── index.ts
│   ├── manifest.json
│   ├── utils.ts
│   └── types.ts (optional)
├── script-name-2/
│   └── ...
package.json
vite.config.ts
tsconfig.json
```

## Common Tasks
- **Add new script**: `npm run scaffold script-name`
- **Build all**: `npm run build`
- **Lint fix**: `npm run lint:fix`
- **Test**: `npm run test`
- **Watch mode**: `vite build --watch`

## Integration Points
- Perplexity UI: Query input, response panel, sidebar
- Storage: LocalStorage fallback for GM_setValue
- Events: Custom `perplexity:query-sent`, `perplexity:response-received` (define if needed)

## Troubleshooting
- **Script not loading**: Check manifest header, ensure userscript manager is enabled
- **DOM not found**: Perplexity uses React; use MutationObserver or wait for element
- **CORS issues**: Use `GM_xmlhttpRequest` instead of fetch
- **Performance drops**: Profile with DevTools, check for memory leaks, debounce events

## References
- [Tampermonkey Docs](https://www.tampermonkey.net/documentation.php)
- [ViteMonkey Docs](https://github.com/lisongedu/vite-plugin-monkey)
- [Perplexity API Docs](https://docs.perplexity.ai/)
- [TypeScript Best Practices](https://www.typescriptlang.org/docs/handbook/)
