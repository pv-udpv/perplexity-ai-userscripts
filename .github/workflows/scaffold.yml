name: Auto-Scaffold Userscript

on:
  issues:
    types: [opened, edited]

jobs:
  scaffold:
    if: contains(github.event.issue.labels.*.name, 'scaffold-request')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            
            // Parse YAML-style issue template
            const nameMatch = body.match(/### Script Name\s*\n\s*(.+)/);
            const urlMatch = body.match(/### Target URL\s*\n\s*(.+)/);
            const featuresMatch = body.match(/### Features to Implement\s*\n\s*([\s\S]+?)(?=###|$)/);
            
            if (!nameMatch || !urlMatch) {
              core.setFailed('Issue format invalid. Please provide Script Name and Target URL.');
              return;
            }
            
            const name = nameMatch[1].trim();
            const url = urlMatch[1].trim();
            const features = featuresMatch ? featuresMatch[1].trim() : '';
            
            // Validate name format
            if (!/^[a-z][a-z0-9-]*$/.test(name)) {
              core.setFailed('Script name must be kebab-case (lowercase with hyphens)');
              return;
            }
            
            core.setOutput('name', name);
            core.setOutput('url', url);
            core.setOutput('features', features);
            
            console.log(`Parsed name: ${name}`);
            console.log(`Parsed url: ${url}`);
            console.log(`Parsed features: ${features}`);
      
      - name: Install dependencies
        run: npm ci
        env:
          PUPPETEER_SKIP_DOWNLOAD: true
      
      - name: Install Chrome for Puppeteer
        run: npx puppeteer browsers install chrome
      
      - name: Extract DOM structure
        id: dom
        run: |
          node scripts/scaffold/extract-dom.js \
            --url "${{ steps.parse.outputs.url }}" \
            --output ./temp-dom.json
        continue-on-error: true
      
      - name: Extract API structure
        id: api
        run: |
          node scripts/scaffold/extract-api.js \
            --url "${{ steps.parse.outputs.url }}" \
            --output ./temp-api.json
        continue-on-error: true
      
      - name: Generate scaffolding
        run: |
          node scripts/scaffold/enhanced-scaffold.js \
            --name "${{ steps.parse.outputs.name }}" \
            --type userscript \
            --dom ./temp-dom.json \
            --api ./temp-api.json \
            --features "${{ steps.parse.outputs.features }}"
      
      - name: Lint generated code
        run: npm run lint:fix || true
        continue-on-error: true
      
      - name: Type check
        run: npm run type-check || true
        continue-on-error: true
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create PR
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            const name = '${{ steps.parse.outputs.name }}';
            const branch = `feat/scaffold-${name}`;
            
            try {
              // Create and switch to new branch
              execSync(`git checkout -b ${branch}`, { stdio: 'inherit' });
              
              // Add all generated files
              execSync('git add scripts/', { stdio: 'inherit' });
              execSync('git add package.json', { stdio: 'inherit' });
              
              // Remove temporary files
              execSync('rm -f temp-dom.json temp-api.json', { stdio: 'inherit' });
              
              // Commit changes
              execSync(`git commit -m "feat: scaffold ${name} userscript"`, { stdio: 'inherit' });
              
              // Push to remote
              execSync(`git push -u origin ${branch}`, { stdio: 'inherit' });
              
              // Read SCAFFOLD_README if it exists
              const scaffoldReadmePath = `scripts/${name}/SCAFFOLD_README.md`;
              let prBody = `## Auto-scaffolded userscript: ${name}\n\n`;
              
              if (fs.existsSync(scaffoldReadmePath)) {
                prBody += fs.readFileSync(scaffoldReadmePath, 'utf-8');
              } else {
                prBody += `Scaffolding completed successfully.\n\nPlease review the generated files in \`scripts/${name}/\` and implement the required features.`;
              }
              
              // Create PR
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `feat: ${name} (auto-scaffolded)`,
                head: branch,
                base: 'main',
                body: prBody
              });
              
              console.log(`Created PR #${pr.data.number}`);
              core.setOutput('pr-number', pr.data.number);
              
              // Comment on issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `✅ Scaffolding complete! Pull request #${pr.data.number} has been created with the generated code.\n\nNext steps:\n1. Review the generated files\n2. Implement the features\n3. Test locally\n4. Merge when ready`
              });
              
            } catch (error) {
              core.setFailed(`Failed to create PR: ${error.message}`);
              
              // Comment error on issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `❌ Scaffolding failed: ${error.message}\n\nPlease check the workflow logs for more details.`
              });
            }
