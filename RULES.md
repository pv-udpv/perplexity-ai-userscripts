# Project Rules & Guidelines for perplexity-ai-userscripts

## 1. Code Quality Standards

### TypeScript & JavaScript
- **Strict Mode**: All `.ts` files must use `strict: true` in `tsconfig.json`
- **No `any` Type**: Explicit types required. Use `unknown` + type guard if uncertain
- **ESLint Config**: Enforce consistent style (see `.eslintrc.json`)
- **Prettier**: Auto-format on save (2-space indent, single quotes for strings)
- **Max Line Length**: 100 characters (readability + diffs)
- **Naming**: camelCase for vars/functions, PascalCase for classes/types, UPPER_SNAKE for constants

### DOM Manipulation
```typescript
// ✅ GOOD: Modern DOM API, type-safe
const btn = document.querySelector<HTMLButtonElement>('.my-btn');
if (btn) btn.addEventListener('click', handleClick);

// ❌ BAD: jQuery, implicit any, innerHTML risk
$('.my-btn').click(handleClick);
elem.innerHTML = userInput; // XSS vulnerability
```

### Error Handling
- Wrap async operations in try-catch
- Log errors with context: `console.error('[script-name] Failed to X:', error)`
- Gracefully degrade if Perplexity UI changes (don't crash)
- Never silently fail; inform user if feature unavailable

### Performance
- Debounce/throttle event handlers (e.g., input listeners)
- Use MutationObserver only when necessary (Perplexity is React; elements may change)
- Clean up event listeners on unload
- Profile with DevTools before committing (aim for <50ms main thread blocks)

## 2. Userscript Standards

### Manifest Header
Auto-generated by ViteMonkey, must include:
```javascript
// @name         Script Name
// @namespace    https://github.com/pv-udpv/perplexity-ai-userscripts
// @version      1.0.0
// @description  Brief description
// @author       Your Name
// @match        https://www.perplexity.ai/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @run-at       document-start | document-idle (default)
```

### Compatibility
- **Target Browsers**: Chrome 90+, Firefox 88+, Safari 15+
- **Userscript Managers**: Tampermonkey, Violentmonkey (test both)
- **Perplexity**: Must work on current live UI (check weekly for breaking changes)

### API Usage
- **Storage**: Use `GM_setValue(key, JSON.stringify(value))` / `GM_getValue(key)`
- **HTTP Requests**: Use `GM_xmlhttpRequest({ url, method, headers, ... })`
- **Timers**: Standard `setTimeout` / `setInterval` (userscript sandbox supports these)
- **No External Libraries**: Bundle everything or define inline (no CDN fetches)

## 3. Security & Privacy

### No Hardcoded Secrets
- Never commit API keys, auth tokens, or credentials
- Use `GM_getValue` to store user config (encrypted by userscript manager)
- Document required permissions in manifest

### XSS Prevention
```typescript
// ❌ NEVER: Direct HTML injection
elem.innerHTML = userInput;

// ✅ ALWAYS: Text content or createElement
elem.textContent = userInput;
const div = document.createElement('div');
div.textContent = userInput;
elem.appendChild(div);
```

### Rate Limiting
- Respect Perplexity's rate limits
- Add exponential backoff for retries
- Cache results locally (GM_setValue) to reduce requests
- Log rate-limit events for debugging

### Respecting TOS
- Don't automate features that require paid access without explicit user consent
- Don't scrape/export user data at scale
- Don't impersonate users or bypass authentication
- Honor Perplexity's robots.txt (if applicable)

## 4. Repository Structure

```
perplexity-ai-userscripts/
├── .copilot-instructions.md      # AI assistant guidelines
├── .eslintrc.json                # Linting rules
├── .prettierrc.json              # Formatting
├── .gitignore
├── CONTRIBUTING.md               # Contributing guide
├── RULES.md                      # This file
├── README.md                     # Project overview
├── CHANGELOG.md                  # Version history
├── package.json                  # Dependencies, scripts
├── tsconfig.json                 # TypeScript config
├── vite.config.ts                # Build config
├── scripts/
│   ├── script-one/
│   │   ├── index.ts              # Main script
│   │   ├── manifest.json         # Metadata
│   │   ├── utils.ts              # Helpers
│   │   ├── types.ts              # TypeScript types
│   │   └── __tests__/            # Vitest specs
│   │       └── index.test.ts
│   └── script-two/
│       └── ...
├── dist/                         # Built .user.js files (generated)
└── node_modules/                 # Dependencies (gitignored)
```

## 5. Naming Conventions

### Repository
- Format: `perplexity-ai-userscripts` (kebab-case)
- Descriptive but concise

### Scripts
- Format: `kebab-case` for folder names
- Example: `chat-history-search`, `response-exporter`, `keyboard-shortcuts`

### TypeScript Files
- `index.ts` - Main entry point
- `utils.ts` - Shared utilities
- `types.ts` - Type definitions
- `__tests__/index.test.ts` - Unit tests

### Functions & Variables
```typescript
const API_TIMEOUT = 5000;              // Constants
const userPreferences = {};            // Variables
function initializeScript() {}         // Functions
interface ScriptConfig {}              // Types/Interfaces
class ScriptManager {}                 // Classes
```

## 6. Commit & PR Guidelines

### Commit Messages
```
feat: add feature X
fix: resolve bug Y
refactor: simplify logic in module Z
docs: update README with examples
test: add unit tests for parser
chore: upgrade dependencies
ci: update GitHub Actions workflow
```

### Branch Naming
```
feat/feature-name
fix/issue-number
refactor/component-name
docs/section-name
```

### PR Checklist
- [ ] Branch up-to-date with `main`
- [ ] No merge conflicts
- [ ] Tests pass locally (`npm test`)
- [ ] Linter passes (`npm run lint`)
- [ ] TypeScript strict: `tsc --noEmit`
- [ ] Tested on live Perplexity AI
- [ ] Changelog updated
- [ ] Commit messages follow convention

## 7. Documentation

### README (per script)
Each script should document:
- **What it does**: 1-2 sentence summary
- **How to install**: Link to userscript manager, install button
- **Configuration**: Settings (if any), storage keys
- **Usage**: Examples, keyboard shortcuts, UI changes
- **Compatibility**: Tested browsers, known issues
- **License**: Same as main project

### Code Comments
- Explain *why*, not *what* (code shows what)
- Use JSDoc for functions:
```typescript
/**
 * Fetch chat history for the current session.
 * @param sessionId - Unique session identifier
 * @returns Promise<ChatMessage[]> - Array of messages
 * @throws {Error} If session not found
 */
async function getChatHistory(sessionId: string): Promise<ChatMessage[]> {
  // Implementation
}
```

## 8. Testing

### Unit Tests
- Minimum 80% code coverage for new features
- Test happy path + edge cases + errors
- Mock DOM elements with testing library
- Use `describe` + `it` for clear test organization

### Integration Tests
- Test on actual Perplexity AI site before PR
- Verify no console errors
- Check storage persistence
- Test with Tampermonkey + Violentmonkey

### Performance Tests
- Script load time < 2 seconds
- Main thread blocks < 50ms
- Memory: no growth on repeated use

## 9. Versioning

### Semantic Versioning (MAJOR.MINOR.PATCH)
- **MAJOR** (1.0.0): Breaking changes to script behavior/config
- **MINOR** (1.1.0): New features, backward compatible
- **PATCH** (1.0.1): Bug fixes, docs

### Version Locations
- `package.json`: Top-level version
- `scripts/<name>/manifest.json`: Per-script version
- Userscript header (auto-generated): `// @version`

## 10. Dependencies

### Restrictions
- Minimal external deps (userscript sandbox limitations)
- Prefer standard library + built-in APIs
- If adding dependency: justify in PR (code size impact, browser support)
- No jQuery (modern DOM API only)
- Prefer sync operations (userscript init is blocking)

### package.json
```json
{
  "name": "perplexity-ai-userscripts",
  "version": "1.0.0",
  "scripts": {
    "build": "vite build",
    "build:watch": "vite build --watch",
    "test": "vitest",
    "lint": "eslint . --ext .ts,.tsx",
    "lint:fix": "eslint . --ext .ts,.tsx --fix",
    "format": "prettier --write \"**/*.{ts,json,md}\""
  },
  "devDependencies": {
    "typescript": "^5.0",
    "vite": "^latest",
    "vitest": "^latest",
    "eslint": "^latest",
    "prettier": "^latest"
  }
}
```

## 11. Release Checklist

- [ ] Version bumped in `package.json` + `scripts/*/manifest.json`
- [ ] CHANGELOG.md updated with release notes
- [ ] All tests passing
- [ ] Linting passes
- [ ] Built files generated (`npm run build`)
- [ ] `dist/` files committed (or auto-published by CI)
- [ ] Git tag created: `git tag v1.0.0`
- [ ] Release notes published on GitHub

## 12. Forbidden Practices

❌ **Never**:
- Use `eval()` or `Function()` constructor
- Modify global prototypes
- Hardcode user credentials
- Make unauthorized API calls
- Spam console with logs
- Use deprecated APIs
- Ignore TypeScript/ESLint errors
- Commit to `main` without PR review
- Change rules.md without discussion

✅ **Always**:
- Write tests for new logic
- Document breaking changes
- Review for XSS vulnerabilities
- Consider Perplexity UI changes
- Respect user privacy
- Clean up resources on unload
- Use type safety
- Seek feedback early

---

**Questions about rules?** Open an issue or discussion. Rules can evolve with project needs.
